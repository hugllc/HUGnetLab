<?xml version="1.0" encoding="UTF-8"?>
<!-- Generated by PHP Project Wizard (PPW) 1.0.4 on Mon Oct 3 15:21:39 CDT 2011 -->

<project name="deb" default="build" basedir=".">
    <property name="deb.setup" value="${basedir}/deb/lab"/>
    <property name="deb.source" value="${basedir}/"/>
    <property name="deb.staging" value="${basedir}/build/deb"/>
    <property name="deb.view.setup" value="${basedir}/deb/view"/>
    <property name="deb.view.source" value="${basedir}/view"/>
    <property name="deb.view.staging" value="${basedir}/build/view/deb"/>
    <property name="deb.system.setup" value="${basedir}/deb/system"/>
    <property name="deb.system.source" value="${basedir}/system"/>
    <property name="deb.system.staging" value="${basedir}/build/system/deb"/>
    <property name="deb.server.setup" value="${basedir}/deb/server"/>
    <property name="deb.server.source" value="${basedir}/server"/>
    <property name="deb.server.staging" value="${basedir}/build/server/deb"/>
    <property name="deb.release" value="" />
    <property name="deb.prefix" value="/usr" />
    <property name="deb.versionfile" value="${basedir}/include/VERSION.TXT" />

    <exec executable="grep" failonerror="true"
        outputproperty="deb.version" errorproperty="deb.versionerror">
        <arg line='-o -e "[0-9]\{1,\}\.[0-9]\{1,\}\.[0-9]\{1,\}[-~alpha0-9]\{0,\}" ${deb.versionfile}'
            />
    </exec>
    <property name="deb.builddir" value="${basedir}/rel" />
    <property name="deb.outputfile" value="${deb.builddir}/HUGnetLabUI_${deb.version}${deb.release}_all.deb" />
    <property name="deb.view.outputfile" value="${deb.builddir}/HUGnetView_${deb.version}${deb.release}_all.deb" />
    <property name="deb.system.outputfile" value="${deb.builddir}/HUGnetLab_${deb.version}${deb.release}_all.deb" />
    <property name="deb.server.outputfile" value="${deb.builddir}/HUGnetLabServer_${deb.version}${deb.release}_all.deb" />
    <property name="deb.postloc" value="hugnet.int.hugllc.com:/home/reprepro/incoming/" />

    <target name="clean" description="Clean up and create artifact directories">
        <delete dir="${deb.staging}" failonerror="false"/>
        <delete dir="${deb.view.staging}" failonerror="false"/>
        <delete dir="${deb.server.staging}" failonerror="false"/>
        <delete dir="${deb.system.staging}" failonerror="false"/>
        <delete failonerror="false">
            <fileset dir="${deb.builddir}" includes="*.deb"/>
        </delete>
    </target>

    <target name="setup" description="Copy all of the files to build the deb">
        <echo>Setting up for HUGnetLab 'v${deb.version}'</echo>

        <mkdir dir="${deb.staging}"/>
        <copy todir="${deb.staging}">
            <fileset dir="${deb.setup}"/>
        </copy>
        <mkdir dir="${deb.staging}/var/www"/>
        <copy todir="${deb.staging}/var/www">
            <fileset dir="${deb.source}/html"/>
        </copy>
        <mkdir dir="${deb.staging}${deb.prefix}/share/php/HUGnetLab"/>
        <copy todir="${deb.staging}${deb.prefix}/share/php/HUGnetLab">
            <fileset dir="${deb.source}/include"/>
        </copy>
        <chmod file="${deb.staging}/DEBIAN/postinst" perm="ugo+rx"/>
        <chmod file="${deb.staging}/DEBIAN/prerm" perm="ugo+rx"/>
        <chmod file="${deb.staging}/DEBIAN/postrm" perm="ugo+rx"/>
        <replaceregexp file="${deb.staging}/DEBIAN/control"
                    match="%VERSION%"
                    replace="${deb.version}"
        />
    </target>
    <target name="setupview" description="Copy all of the files to build the deb">
        <echo>Setting up for HUGnetView 'v${deb.version}'</echo>

        <mkdir dir="${deb.view.staging}"/>
        <copy todir="${deb.view.staging}">
            <fileset dir="${deb.view.setup}"/>
        </copy>
        <mkdir dir="${deb.view.staging}/var/www"/>
        <copy todir="${deb.view.staging}/var/www">
            <fileset dir="${deb.view.source}/"/>
        </copy>
        <chmod file="${deb.view.staging}/DEBIAN/postinst" perm="ugo+rx"/>
        <chmod file="${deb.view.staging}/DEBIAN/prerm" perm="ugo+rx"/>
        <chmod file="${deb.view.staging}/DEBIAN/postrm" perm="ugo+rx"/>
        <replaceregexp file="${deb.view.staging}/DEBIAN/control"
                    match="%VERSION%"
                    replace="${deb.version}"
        />
    </target>
    <target name="setupsystem" description="Copy all of the files to build the deb">
        <echo>Setting up for HUGnetLabSystem 'v${deb.version}'</echo>

        <mkdir dir="${deb.system.staging}"/>
        <copy todir="${deb.system.staging}">
            <fileset dir="${deb.system.setup}"/>
        </copy>
        <chmod file="${deb.system.staging}/DEBIAN/postinst" perm="ugo+rx"/>
        <chmod file="${deb.system.staging}/DEBIAN/prerm" perm="ugo+rx"/>
        <chmod file="${deb.system.staging}/DEBIAN/postrm" perm="ugo+rx"/>
        <chmod file="${deb.system.staging}/DEBIAN/config" perm="ugo+rx"/>
        <replaceregexp file="${deb.system.staging}/DEBIAN/control"
                    match="%VERSION%"
                    replace="${deb.version}"
        />
    </target>
    <target name="setupserver" description="Copy all of the files to build the deb">
        <echo>Setting up for HUGnetLabServer 'v${deb.version}'</echo>

        <mkdir dir="${deb.server.staging}"/>
        <copy todir="${deb.server.staging}">
            <fileset dir="${deb.server.setup}"/>
        </copy>
        <chmod file="${deb.server.staging}/DEBIAN/postinst" perm="ugo+rx"/>
        <chmod file="${deb.server.staging}/DEBIAN/prerm" perm="ugo+rx"/>
        <chmod file="${deb.server.staging}/DEBIAN/postrm" perm="ugo+rx"/>
        <chmod file="${deb.server.staging}/DEBIAN/config" perm="ugo+rx"/>
        <replaceregexp file="${deb.server.staging}/DEBIAN/control"
                    match="%VERSION%"
                    replace="${deb.version}"
        />
    </target>
    <target name="deb" description="build the deb">
        <mkdir dir="${deb.builddir}"/>
        <exec executable="dpkg" failonerror="true">
            <arg line="-b ${deb.staging}
                       ${deb.outputfile}"/>
        </exec>
    </target>
    <target name="debview" description="build the deb">
        <mkdir dir="${deb.builddir}"/>
        <exec executable="dpkg" failonerror="true">
            <arg line="-b ${deb.view.staging}
                       ${deb.view.outputfile}"/>
        </exec>
    </target>
    <target name="debsystem" description="build the deb">
        <mkdir dir="${deb.builddir}"/>
        <exec executable="dpkg" failonerror="true">
            <arg line="-b ${deb.system.staging}
                       ${deb.system.outputfile}"/>
        </exec>
    </target>
    <target name="debserver" description="build the deb">
        <mkdir dir="${deb.builddir}"/>
        <exec executable="dpkg" failonerror="true">
            <arg line="-b ${deb.server.staging}
                       ${deb.server.outputfile}"/>
        </exec>
    </target>
    <target name="sign" description="sign the deb">
        <exec executable="dpkg-sig" failonerror="true" dir="${deb.builddir}">
            <arg line="-s builder
                       ${deb.outputfile}"/>
        </exec>
    </target>
    <target name="post" description="post the deb" depends="build">
        <exec executable="rsync" failonerror="true" dir="${deb.builddir}">
            <arg line="-av ${deb.outputfile}
                        ${deb.postloc}main/"/>
        </exec>
        <exec executable="rsync" failonerror="true" dir="${deb.builddir}">
            <arg line="-av ${deb.view.outputfile}
                        ${deb.postloc}main/"/>
        </exec>
        <exec executable="rsync" failonerror="true" dir="${deb.builddir}">
            <arg line="-av ${deb.system.outputfile}
                        ${deb.postloc}main/"/>
        </exec>
        <exec executable="rsync" failonerror="true" dir="${deb.builddir}">
            <arg line="-av ${deb.server.outputfile}
                        ${deb.postloc}main/"/>
        </exec>
    </target>
    <target name="testpost" description="post the deb" depends="build">
        <exec executable="rsync" failonerror="true" dir="${deb.builddir}">
            <arg line="-av ${deb.outputfile}
                        ${deb.postloc}testing/"/>
        </exec>
        <exec executable="rsync" failonerror="true" dir="${deb.builddir}">
            <arg line="-av ${deb.view.outputfile}
                        ${deb.postloc}testing/"/>
        </exec>
        <exec executable="rsync" failonerror="true" dir="${deb.builddir}">
            <arg line="-av ${deb.system.outputfile}
                        ${deb.postloc}testing/"/>
        </exec>
        <exec executable="rsync" failonerror="true" dir="${deb.builddir}">
            <arg line="-av ${deb.server.outputfile}
                        ${deb.postloc}testing/"/>
        </exec>
    </target>
    <target name="postclean" description="build the deb">
        <delete dir="${deb.staging}"/>
        <delete dir="${deb.view.staging}"/>
        <delete dir="${deb.system.staging}"/>
    </target>
    <target name="build" depends="clean,setup,setupview,setupsystem,setupserver,deb,debview,debsystem,debserver"/>

</project>
